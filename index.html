<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>å°ç£ç©ºæ°£ V21 (AIç‰ˆ)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
body{font-family:"Microsoft JhengHei",sans-serif;background:#f4f4f9;color:#333;margin:0;padding:0;display:flex;flex-direction:column;height:100vh}
header{background:#2c3e50;color:#fff;padding:10px 15px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,.2);z-index:1000}
.title-group{display:flex;flex-direction:column} h1{margin:0;font-size:1.1rem;display:flex;align-items:center;gap:5px} .sub-info{font-size:.75rem;color:#bdc3c7;margin-top:2px;display:flex;gap:10px}
.view-switch{display:flex;background:rgba(255,255,255,.2);border-radius:20px;padding:2px;margin-left:10px} .btn{padding:6px 12px;border:none;border-radius:18px;cursor:pointer;font-size:.9rem;background:0 0;color:rgba(255,255,255,.7)} .btn.active{background:#fff;color:#2c3e50;font-weight:700}
#main{flex:1;position:relative;overflow:hidden} 
.float-btns{position:absolute;bottom:25px;right:20px;z-index:999;display:flex;flex-direction:column;gap:10px}
.float-btn{background:#fff;border:none;width:50px;height:50px;border-radius:50%;box-shadow:0 4px 10px rgba(0,0,0,.3);cursor:pointer;font-size:1.5rem;color:#2c3e50;display:flex;justify-content:center;align-items:center;transition:transform .2s} .float-btn:active{transform:scale(.9)}
#list{padding:15px;overflow-y:auto;height:100%;box-sizing:border-box;display:none;background:#f0f2f5} .search{width:100%;padding:12px;margin-bottom:15px;border:1px solid #ddd;border-radius:8px;font-size:16px;box-sizing:border-box} .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:15px}
.card{background:#fff;padding:15px;border-radius:12px;box-shadow:0 2px 5px rgba(0,0,0,.05);text-align:center;position:relative;transition:transform .2s} .card:active{transform:scale(.98)} .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:5px} .card-aqi{font-size:2.2em;font-weight:800;margin:5px 0}
.fav-btn{cursor:pointer;color:#ccc;font-size:1.2em;padding:5px} .fav-btn.active,.fav-badge{color:#e74c3c} .fav-badge{position:absolute;top:10px;right:10px;display:none} .card.is-fav{border:2px solid #e74c3c} .card.is-fav .fav-badge{display:block}
#loading{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,.98);z-index:2000;display:flex;flex-direction:column;justify-content:center;align-items:center;transition:opacity .3s;pointer-events:none;opacity:0} #loading.show{opacity:1;pointer-events:all} .spinner{border:4px solid #f3f3f3;border-top:4px solid #2c3e50;border-radius:50%;width:30px;height:30px;animation:spin .8s linear infinite;margin-bottom:10px} @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.custom-popup .leaflet-popup-content-wrapper{padding:0;overflow:hidden;border-radius:12px} .custom-popup .leaflet-popup-content{margin:0;width:300px!important} .popup-hdr{padding:12px 15px;color:#fff;text-align:center;font-weight:700;font-size:1.1em;display:flex;justify-content:space-between;align-items:center} .popup-bd{padding:0 15px 10px;text-align:center}
.info-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin:10px 0} .info-item{background:#f8f9fa;padding:8px 4px;border-radius:8px;font-size:.85em;display:flex;flex-direction:column;align-items:center} .info-val{font-weight:700;font-size:1.1em;color:#333} .w-arr{transition:transform .5s ease-out;color:#2980b9}
.pollutant-row{display:flex;justify-content:space-around;color:#666;font-size:.9em;margin-bottom:10px;border-bottom:1px dashed #eee;padding-bottom:10px}
.chart-container{position:relative;height:120px;width:100%;margin-top:5px;display:none} .chart-loading{font-size:.8em;color:#999;margin-top:10px;display:block}
.act-row{display:flex;gap:10px;margin-top:10px} .act-btn{flex:1;padding:8px;border:none;border-radius:6px;cursor:pointer;font-weight:700;font-size:.9em;display:flex;align-items:center;justify-content:center;gap:5px} .btn-cp{background:#2ecc71;color:#fff} .btn-cp:active{background:#27ae60;transform:scale(.98)} .btn-fv{background:#ecf0f1;color:#555} .btn-fv.active{background:#fadbd8;color:#c0392b}

/* AI å€å¡Šæ¨£å¼ */
.ai-box { background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%); border-radius: 8px; padding: 10px; margin: 10px 0; border: 1px solid #e1e4e8; font-size: 0.9em; text-align: left; }
.ai-title { font-weight: bold; color: #2c3e50; display: flex; align-items: center; gap: 5px; margin-bottom: 5px; font-size: 0.95em; }
.ai-content { color: #555; line-height: 1.4; }
.trend-up { color: #c0392b; font-weight: bold; }
.trend-down { color: #27ae60; font-weight: bold; }
.trend-flat { color: #7f8c8d; font-weight: bold; }
</style>
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
</head>
<body>
<header>
    <div class="title-group"><h1><i class="fa-solid fa-robot"></i> å°ç£ç©ºæ°£ AI</h1><div class="sub-info"><span id="ut">æ›´æ–°ä¸­...</span><span id="busuanzi_container_site_pv" style="display:none"><i class="fa-solid fa-eye"></i> <span id="busuanzi_value_site_pv">--</span></span></div></div>
    <div class="view-switch"><button id="btn-map" class="btn active" onclick="setView('map')">åœ°åœ–</button><button id="btn-list" class="btn" onclick="setView('list')">åˆ—è¡¨</button></div>
</header>
<div id="main">
    <div id="loading" class="show"><div class="spinner"></div><div id="lt">è¼‰å…¥ä¸­...</div></div>
    <div id="map-view" style="width:100%;height:100%"></div>
    <div class="float-btns"><button class="float-btn" onclick="locate()"><i class="fa-solid fa-crosshairs"></i></button></div>
    <div id="list"><input type="text" id="sInput" class="search" placeholder="ğŸ” æœå°‹..." onkeyup="filter()"><div id="dash" class="grid"></div></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
const KEY="d62dcdf1-adf6-49dd-9c9c-b65b1556323d", API=`https://data.moenv.gov.tw/api/v2/aqx_p_432?language=zh&api_key=${KEY}&$select=sitename,county,aqi,status,pm2.5,pm10,longitude,latitude,publishtime`;
let map, markers, uMk, data=[], favs=[], chart, rendered=false;
const el = (id) => document.getElementById(id);
const getAQI = (v) => { if(v<=50)return{c:'#009866',t:'è‰¯å¥½'}; if(v<=100)return{c:'#FFDE33',t:'æ™®é€š'}; if(v<=150)return{c:'#FF9933',t:'æ•æ„Ÿ'}; if(v<=200)return{c:'#CC0033',t:'ä¸å¥åº·'}; if(v<=300)return{c:'#660099',t:'æ¥µå·®'}; return{c:'#7E0023',t:'å±å®³'}; };
const getAdv = (aqi) => {
    if(aqi<=50) return {icon:"ğŸŸ¢", txt:"ç©ºæ°£ä¸éŒ¯ï¼Œé©åˆæˆ¶å¤–æ´»å‹• ğŸƒ"};
    if(aqi<=100) return {icon:"ğŸŸ¡", txt:"ç©ºæ°£æ™®é€šï¼Œæ•æ„Ÿæ—ç¾¤è«‹æ³¨æ„ ğŸ˜"};
    if(aqi<=150) return {icon:"ğŸŸ ", txt:"å°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·ï¼Œå»ºè­°æˆ´å£ç½© ğŸ˜·"};
    if(aqi<=200) return {icon:"ğŸ”´", txt:"ç©ºæ°£å·®ï¼æ‰€æœ‰äººéƒ½æ‡‰æˆ´å£ç½© ğŸš«"};
    if(aqi<=300) return {icon:"ğŸŸ£", txt:"éå¸¸ä¸å¥åº·ï¼Œé¿å…å‡ºé–€ âš ï¸"};
    return {icon:"â˜ ï¸", txt:"å±å®³ç­‰ç´šï¼è«‹ç•™åœ¨å®¤å…§ â˜ ï¸"};
};

window.onload = () => {
    try { favs = JSON.parse(localStorage.getItem("AQI_FAV"))||[]; } catch{}
    setTimeout(()=>el('loading').classList.remove('show'), 4000);
    initMap();
    let c = localStorage.getItem("AQI_CACHE");
    if(c){ data=JSON.parse(c); drawMap(data); el('loading').classList.remove('show'); el('ut').innerText=localStorage.getItem("AQI_TIME")+"(å¿«å–)"; }
    fetchData(!c); setInterval(()=>fetchData(false), 600000);
};

function initMap(){
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OSM'});
    map = L.map('map-view',{zoomControl:false,layers:[osm]}).setView([23.7,121],7);
    L.control.layers({"åœ°åœ–":osm,"è¡›æ˜Ÿ":L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}')}).addTo(map);
    L.control.zoom({position:'bottomleft'}).addTo(map);
    markers = L.layerGroup().addTo(map);
    map.on('popupopen', e => { if(e.popup._source.sd) setTimeout(()=>loadDet(e.popup._source.sd),10); });
}

async function fetchData(load){
    if(load) el('loading').classList.add('show');
    try{
        const r = await fetch(API+`&t=${new Date().getTime()}`, {signal:AbortSignal.timeout(10000)});
        const j = await r.json();
        if(j.records.length){
            data = j.records; drawMap(data);
            if(el('list').style.display==='block') drawList(data); else rendered=false;
            localStorage.setItem("AQI_CACHE",JSON.stringify(data));
            let t = new Date().toTimeString().substr(0,5);
            el('ut').innerText = t+" æ›´æ–°"; localStorage.setItem("AQI_TIME", t);
        }
    }catch(e){ console.error(e); el('ut').innerText="æ›´æ–°å¤±æ•—"; }
    el('loading').classList.remove('show');
}

function drawMap(d){
    markers.clearLayers();
    d.forEach(s=>{
        if(!s.latitude)return;
        let q=getAQI(s.aqi), isF=favs.includes(s.sitename);
        let m=L.circleMarker([s.latitude,s.longitude],{radius:7,fillColor:q.c,color:isF?'#e74c3c':'#fff',weight:isF?4:1.5,fillOpacity:.9});
        m.sd=s; m.bindPopup(getPop(s,q,false),{className:'custom-popup'});
        markers.addLayer(m);
    });
}

function drawList(d){
    el('dash').innerHTML=''; let frag=document.createDocumentFragment();
    d.sort((a,b)=>{ let fa=favs.includes(a.sitename), fb=favs.includes(b.sitename); return (fa&&!fb)?-1:(!fa&&fb)?1:(b.aqi-a.aqi); }).forEach(s=>{
        let q=getAQI(s.aqi), isF=favs.includes(s.sitename), div=document.createElement('div');
        div.className=`card ${isF?'is-fav':''}`;
        div.onclick=(e)=>{ if(!e.target.closest('.fav-btn')){ setView('map'); let m; markers.eachLayer(l=>{if(l.sd.sitename==s.sitename)m=l}); if(m){map.setView(m.getLatLng(),13);m.openPopup()} } };
        div.innerHTML=`<div class="fav-badge"><i class="fa-solid fa-heart"></i></div><div class="card-header"><div><strong>${s.sitename}</strong> <small style="color:#888">${s.county}</small></div><div class="fav-btn ${isF?'active':''}" onclick="togFav('${s.sitename}')"><i class="${isF?'fa-solid':'fa-regular'} fa-heart"></i></div></div><div class="card-aqi" style="color:${q.c=='#FFDE33'?'#d4b106':q.c}">${s.aqi}</div><div style="background:${q.c};color:#fff;padding:2px 8px;border-radius:10px;display:inline-block">${q.t}</div>`;
        frag.appendChild(div);
    });
    el('dash').appendChild(frag); rendered=true;
}

function getPop(s,q,isNear){
    let isF=favs.includes(s.sitename), id=`c-${Math.random().toString(36).substr(2,5)}`;
    let lbl = isNear ? '<div style="background:#2c3e50;color:#fff;font-size:.8em;padding:2px 6px;border-radius:4px;display:inline-block;margin-bottom:5px">ğŸ“ æœ€è¿‘æ¸¬ç«™</div>' : '';
    return `<div class="popup-hdr" style="background:${q.c};color:${s.aqi>50&&s.aqi<=100?'#333':'#fff'}"><span>${s.sitename}</span><span>AQI ${s.aqi}</span></div>
    <div class="popup-bd"><div style="margin-top:10px">${lbl}</div><div style="display:flex;justify-content:space-around;color:#666;font-size:.9em;margin:5px 0 10px;border-bottom:1px dashed #eee;padding-bottom:10px"><span>PM2.5: <b>${s["pm2.5"]}</b></span><span>PM10: <b>${s.pm10}</b></span></div>
    
    <div id="ai-${id}" class="ai-box"><i class="fa-solid fa-spinner fa-spin"></i> AI åˆ†æä¸­...</div>

    <div id="i-${id}" class="info-grid"><i class="fa-solid fa-spinner fa-spin"></i></div>
    <div class="act-row"><button id="fb-${s.sitename}" class="act-btn btn-fv ${isF?'active':''}" onclick="togFav('${s.sitename}')"><i class="${isF?'fa-solid':'fa-regular'} fa-heart"></i> ${isF?'å·²æ”¶è—':'æ”¶è—'}</button><button class="act-btn btn-cp" onclick="cpRep()"><i class="fa-regular fa-copy"></i> è¤‡è£½å ±å‘Š</button></div>
    <div class="chart-box" id="cb-${id}"><canvas id="${id}"></canvas></div></div>`;
}

// æ ¸å¿ƒ AI ç®—æ³•å€
function analyzeData(h, w, currentAQI) {
    // 1. è¶¨å‹¢è¨ˆç®— (Linear Regression Slope)
    const recent = h.pm2_5.slice(-6); // å–æœ€è¿‘6å°æ™‚
    let n = recent.length, sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
    for (let i=0; i<n; i++) { sumX += i; sumY += recent[i]; sumXY += i * recent[i]; sumXX += i * i; }
    let slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
    
    let trendTxt = '<span class="trend-flat">æŒå¹³</span>';
    if(slope > 0.5) trendTxt = '<span class="trend-up">æƒ¡åŒ–ä¸­ ğŸ“ˆ</span>';
    if(slope < -0.5) trendTxt = '<span class="trend-down">æ”¹å–„ä¸­ ğŸ“‰</span>';

    // 2. é«”æ„Ÿåˆ†æ
    let feel = "èˆ’é©";
    if(w.relative_humidity_2m > 80 && w.temperature_2m > 28) feel = "æ‚¶ç†±æ½®æ¿•";
    else if(w.wind_speed_10m > 15) feel = "é¢¨å¤§åå†·";
    else if(w.temperature_2m < 15) feel = "å¯’å†·";

    // 3. ç¶œåˆå»ºè­°
    let advice = "ç©ºæ°£èˆ‡å¤©æ°£çš†é©å®œã€‚";
    if(currentAQI > 100) advice = "ç©ºæ°£å·®ï¼Œå»ºè­°é–‹å•Ÿæ¸…æ·¨æ©Ÿã€‚";
    if(currentAQI > 100 && slope > 0.5) advice = "æ±™æŸ“æ­£å¿«é€Ÿç´¯ç©ï¼Œè«‹å‹™å¿…é—œçª—ï¼";
    if(w.relative_humidity_2m > 85) advice += " æ¿•åº¦æ¥µé«˜ï¼Œæ³¨æ„ç™¼éœ‰ã€‚";

    return { trend: trendTxt, feel: feel, advice: advice };
}

async function loadDet(s){
    let id=document.querySelector('.custom-popup canvas')?.id; if(!id)return;
    window.cpRep=()=>{};
    try{
        let [rW,rA]=await Promise.all([
            fetch(`https://api.open-meteo.com/v1/forecast?latitude=${s.latitude}&longitude=${s.longitude}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m,uv_index&timezone=auto`),
            fetch(`https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${s.latitude}&longitude=${s.longitude}&hourly=pm2_5&timezone=auto&past_days=1&forecast_days=0`)
        ]);
        let w=(await rW.json()).current, h=(await rA.json()).hourly;
        
        // åŸ·è¡Œ AI åˆ†æ
        let ai = analyzeData(h, w, parseInt(s.aqi));
        el(`ai-${id}`).innerHTML = `<div class="ai-title"><i class="fa-solid fa-wand-magic-sparkles" style="color:#8e44ad"></i> AI é åˆ¤ï¼š${ai.trend}</div><div class="ai-content">é«”æ„Ÿï¼š${ai.feel}<br>å»ºè­°ï¼š${ai.advice}</div>`;

        window.cpRep=()=>{
            let st = getAdv(parseInt(s.aqi));
            let txt=`ã€ç©ºæ°£å¿«å ±ã€‘${s.sitename} ${st.icon}\n----------\nğŸ­ AQI: ${s.aqi} (${s.status})\nğŸ”® è¶¨å‹¢: ${ai.trend.replace(/<[^>]*>/g, '')}\nğŸ’¡ å»ºè­°: ${ai.advice}\nğŸŒ¡ï¸ ${w.temperature_2m}Â°C ğŸ’§ ${w.relative_humidity_2m}%\n----------\nğŸ”— æŸ¥çœ‹åœ°åœ–: ${location.href}`;
            navigator.clipboard.writeText(txt).then(()=>alert("âœ… å ±å‘Šå·²è¤‡è£½ï¼")).catch(()=>alert("è¤‡è£½å¤±æ•—"));
        };

        el(`i-${id}`).innerHTML=`<div class="info-item"><div>æ°£æº«/æ¿•åº¦</div><div class="info-val">${w.temperature_2m}Â° <small>${w.relative_humidity_2m}%</small></div></div><div class="info-item"><div>UVæŒ‡æ•¸</div><div class="info-val" style="color:${w.uv_index>6?'#e74c3c':w.uv_index>3?'#f39c12':'#27ae60'}">${w.uv_index}</div></div><div class="info-item"><div>é¢¨å‘</div><div style="display:flex;align-items:center"><i class="fa-solid fa-location-arrow w-arr" style="transform:rotate(${w.wind_direction_10m+180}deg)"></i> <b>${w.wind_speed_10m}</b></div></div>`;
        el(`cb-${id}`).style.display='block';
        if(chart)chart.destroy();
        chart=new Chart(el(id).getContext('2d'),{type:'line',data:{labels:h.time.slice(-24).map(t=>t.slice(11,16)),datasets:[{data:h.pm2_5.slice(-24),borderColor:'#3498db',borderWidth:2,fill:true,backgroundColor:'rgba(52,152,219,.1)',pointRadius:0}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:false},scales:{x:{display:false},y:{display:true}}}});
    }catch{}
}

function togFav(n){
    if(favs.includes(n)) favs=favs.filter(x=>x!==n); else favs.push(n);
    localStorage.setItem("AQI_FAV",JSON.stringify(favs));
    if(el('list').style.display==='block') drawList(data);
    let b=el(`fb-${n}`); if(b){ b.classList.toggle('active'); b.innerHTML=favs.includes(n)?'<i class="fa-solid fa-heart"></i> å·²æ”¶è—':'<i class="fa-regular fa-heart"></i> æ”¶è—';}
}

function setView(m){
    el('map-view').style.display=m=='map'?'block':'none'; el('list').style.display=m=='list'?'block':'none';
    document.querySelector('.float-btns').style.display=m=='map'?'flex':'none';
    el('btn-map').className=`btn ${m=='map'?'active':''}`; el('btn-list').className=`btn ${m=='list'?'active':''}`;
    if(m=='map') map.invalidateSize(); else if(!rendered) drawList(data);
}

function filter(){ drawList(data.filter(d=>d.sitename.includes(el('sInput').value)||d.county.includes(el('sInput').value))); }
function locate(){
    navigator.geolocation.getCurrentPosition(p=>{
        map.setView([p.coords.latitude,p.coords.longitude],14);
        let nr=data.reduce((prev,curr)=>{
            let d=map.distance([p.coords.latitude,p.coords.longitude],[curr.latitude,curr.longitude]);
            return d<prev.d?{d:d,s:curr}:prev;
        },{d:Infinity,s:null}).s;
        if(nr){ 
            if(uMk)map.removeLayer(uMk); 
            uMk=L.marker([p.coords.latitude,p.coords.longitude],{icon:L.divIcon({className:'user-loc',html:'<i class="fa-solid fa-street-view" style="color:#2980b9;font-size:36px;text-shadow:2px 2px 2px #fff"></i>',iconSize:[36,36],iconAnchor:[18,36],popupAnchor:[0,-35]})}).addTo(map);
            uMk.sd=nr; 
            uMk.bindPopup(getPop(nr,getAQI(nr.aqi),true),{className:'custom-popup'}).openPopup();
            setTimeout(()=>loadDet(nr),200);
        }
    },()=>alert("å®šä½å¤±æ•—"));
}
</script>
</body>
</html>
