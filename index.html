<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Âè∞ÁÅ£Á©∫Ê∞£ V11 (ÁæéÂ≠∏Áâà)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        
        header { background-color: #2c3e50; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000;}
        .title-group { display: flex; flex-direction: column; }
        h1 { margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 5px; }
        .update-time { font-size: 0.75rem; color: #bdc3c7; margin-top: 2px; }
        
        .view-switch { display: flex; background: rgba(255,255,255,0.2); border-radius: 20px; padding: 2px; margin-left: 10px;}
        .btn { padding: 6px 12px; border: none; border-radius: 18px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; background: transparent; color: rgba(255,255,255,0.7); white-space: nowrap; }
        .btn.active { background-color: white; color: #2c3e50; font-weight: bold; }

        #main-container { flex: 1; position: relative; overflow: hidden; }

        .gps-btn {
            position: absolute; bottom: 25px; right: 20px; z-index: 999;
            background: white; border: none; width: 50px; height: 50px;
            border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; font-size: 1.5rem; color: #2c3e50;
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s;
        }
        .gps-btn:active { transform: scale(0.9); }

        #list-view { padding: 15px; overflow-y: auto; height: 100%; box-sizing: border-box; display: none; background: #f0f2f5; }
        .search-box { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .card-aqi { font-size: 2.2em; font-weight: 800; margin: 5px 0; }
        
        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; pointer-events: none; opacity: 0; }
        #loading.show { opacity: 1; pointer-events: all; }
        
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2c3e50; border-radius: 50%; width: 30px; height: 30px; animation: spin 0.8s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .bg-good { background: #009866; } .bg-mod { background: #FFDE33; color: #333 !important; }
        .bg-sen { background: #FF9933; } .bg-un { background: #CC0033; }
        .bg-very { background: #660099; } .bg-haz { background: #7E0023; }

        /* Popup ÂÑ™Âåñ */
        .custom-popup .leaflet-popup-content-wrapper { padding: 0; overflow: hidden; border-radius: 12px; }
        .custom-popup .leaflet-popup-content { margin: 0; width: 290px !important; }
        .popup-header { padding: 10px 15px; color: white; text-align: center; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center;}
        .popup-body { padding: 0 15px 15px 15px; text-align: center; }
        
        /* Ê±∫Á≠ñÊñπÂ°ä */
        .decision-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin: 10px 0; }
        .decision-item { background: #f8f9fa; padding: 6px 2px; border-radius: 8px; font-size: 0.8em; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .d-icon { font-size: 1.3em; margin-bottom: 3px; }
        .d-title { color: #888; font-size: 0.85em; }
        .d-status { font-weight: bold; font-size: 0.95em; margin-top: 1px;}
        .st-ok { color: #27ae60; } .st-warn { color: #f39c12; } .st-bad { color: #c0392b; }

        .pollutant-row { display: flex; justify-content: space-around; color: #666; font-size: 0.9em; margin-bottom: 8px; border-bottom: 1px dashed #eee; padding-bottom: 8px;}
        
        .chart-container { position: relative; height: 110px; width: 100%; margin-top: 5px; display: none; }
        .chart-loading { font-size: 0.8em; color: #999; margin-top: 10px; display: block;}

        /* Âú∞ÂúñÂúñÂ±§ÊéßÂà∂Âô®Ê®£ÂºèÂæÆË™ø */
        .leaflet-control-layers { border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border: none; }
    </style>
</head>
<body>

    <header>
        <div class="title-group">
            <h1><i class="fa-solid fa-leaf"></i> Âè∞ÁÅ£Á©∫Ê∞£ V11</h1>
            <div id="update-time" class="update-time">Á≠âÂæÖÊõ¥Êñ∞...</div>
        </div>
        <div class="view-switch">
            <button id="btn-map" class="btn active" onclick="switchView('map')">Âú∞Âúñ</button>
            <button id="btn-list" class="btn" onclick="switchView('list')">ÂàóË°®</button>
        </div>
    </header>

    <div id="main-container">
        <div id="loading" class="show">
            <div class="spinner"></div>
            <div>ÁæéÂ≠∏ÂçáÁ¥ö‰∏≠...</div>
        </div>
        
        <div id="map-view" style="width: 100%; height: 100%;"></div>
        
        <button class="gps-btn" onclick="locateUser()" title="ÂÆö‰ΩçÊàëÁöÑ‰ΩçÁΩÆ">
            <i class="fa-solid fa-crosshairs"></i>
        </button>

        <div id="list-view">
            <input type="text" id="searchInput" class="search-box" placeholder="üîç ÊêúÂ∞ãÁ∏£Â∏ÇÊàñÊ∏¨Á´ô..." onkeyup="filterList()">
            <div id="dashboard" class="grid"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script>
        const API_KEY = "d62dcdf1-adf6-49dd-9c9c-b65b1556323d"; 
        const API_FIELDS = "sitename,county,aqi,status,pm2.5,pm10,longitude,latitude,publishtime";
        const API_URL = `https://data.moenv.gov.tw/api/v2/aqx_p_432?language=zh&api_key=${API_KEY}&$select=${API_FIELDS}`;
        
        const CACHE_KEY = "AQI_DATA_CACHE_V11";
        const CACHE_TIME_KEY = "AQI_LAST_UPDATE_V11";

        let map, markersLayer, userMarker;
        let allData = [];
        let isListRendered = false;
        let currentChart = null;

        window.onload = () => {
            initMap();
            
            const cachedData = loadFromCache();
            if (cachedData) {
                allData = cachedData;
                renderMap(allData);
                document.getElementById('loading').classList.remove('show');
                const lastTime = localStorage.getItem(CACHE_TIME_KEY);
                if(lastTime) document.getElementById('update-time').innerText = `${lastTime} (Âø´Âèñ)`;
            }

            fetchData(cachedData ? false : true);
            setInterval(() => { fetchData(false); }, 600000); 
        };

        function initMap() {
            // ÂÆöÁæ©‰∏âÁ®ÆÂú∞ÂúñÈ¢®Ê†º
            const lightMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            });

            const darkMap = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            });

            const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: '&copy; Esri'
            });

            // ÂàùÂßãÂåñÂú∞ÂúñÔºåÈ†êË®≠‰ΩøÁî® "ÊñáÈùíÈ¢®" (Light Map)
            map = L.map('map-view', { 
                zoomControl: false, 
                fadeAnimation: true,
                layers: [lightMap] // È†êË®≠ÂúñÂ±§
            }).setView([23.7, 121.0], 7);

            // Âä†ÂÖ•ÂúñÂ±§ÂàáÊèõÊéßÂà∂Âô® (Âè≥‰∏äËßí)
            const baseMaps = {
                "‚ú® Á∞°Á¥Ñ (È†êË®≠)": lightMap,
                "üåô ÊöóÈªëÊ®°Âºè": darkMap,
                "üõ∞Ô∏è Ë°õÊòüÂΩ±ÂÉè": satelliteMap
            };
            L.control.layers(baseMaps).addTo(map);

            L.control.zoom({ position: 'bottomleft' }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);

            map.on('popupopen', function(e) {
                const marker = e.popup._source;
                if (marker.stationData) {
                    setTimeout(() => loadStationDetails(marker.stationData), 10);
                }
            });
        }

        async function fetchData(showLoading) {
            const timeDisplay = document.getElementById('update-time');
            const loadingEl = document.getElementById('loading');
            if (showLoading) loadingEl.classList.add('show');
            if (!showLoading) timeDisplay.innerText = "Êõ¥Êñ∞‰∏≠...";

            try {
                const res = await fetch(`${API_URL}&t=${new Date().getTime()}`);
                if (!res.ok) throw new Error("API Error");
                const json = await res.json();
                allData = json.records;
                
                renderMap(allData);
                if (document.getElementById('list-view').style.display === 'block') {
                    renderList(allData);
                } else {
                    isListRendered = false;
                }

                saveToCache(allData);
                
                const now = new Date();
                const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                timeDisplay.innerText = `${timeString} Êõ¥Êñ∞`;
                localStorage.setItem(CACHE_TIME_KEY, timeString);
            } catch (e) {
                console.error(e);
                timeDisplay.innerText = "Êõ¥Êñ∞Â§±Êïó";
            } finally {
                loadingEl.classList.remove('show');
            }
        }

        function saveToCache(data) { try { localStorage.setItem(CACHE_KEY, JSON.stringify(data)); } catch (e) {} }
        function loadFromCache() { try { return JSON.parse(localStorage.getItem(CACHE_KEY)); } catch (e) { return null; } }

        function getAQIInfo(aqi) {
            if (aqi <= 50) return { color: '#009866', class: 'bg-good', text: 'ËâØÂ•Ω' };
            if (aqi <= 100) return { color: '#FFDE33', class: 'bg-mod', text: 'ÊôÆÈÄö' };
            if (aqi <= 150) return { color: '#FF
