<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£ç©ºæ°£ V14 (äº’å‹•ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        
        header { background-color: #2c3e50; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000;}
        .title-group { display: flex; flex-direction: column; }
        h1 { margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 5px; }
        .update-time { font-size: 0.75rem; color: #bdc3c7; margin-top: 2px; }
        
        .view-switch { display: flex; background: rgba(255,255,255,0.2); border-radius: 20px; padding: 2px; margin-left: 10px;}
        .btn { padding: 6px 12px; border: none; border-radius: 18px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; background: transparent; color: rgba(255,255,255,0.7); white-space: nowrap; }
        .btn.active { background-color: white; color: #2c3e50; font-weight: bold; }

        #main-container { flex: 1; position: relative; overflow: hidden; }

        .gps-btn {
            position: absolute; bottom: 25px; right: 20px; z-index: 999;
            background: white; border: none; width: 50px; height: 50px;
            border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; font-size: 1.5rem; color: #2c3e50;
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s;
        }
        .gps-btn:active { transform: scale(0.9); }

        #list-view { padding: 15px; overflow-y: auto; height: 100%; box-sizing: border-box; display: none; background: #f0f2f5; }
        .search-box { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; position: relative; transition: transform 0.2s; }
        .card:active { transform: scale(0.98); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .card-aqi { font-size: 2.2em; font-weight: 800; margin: 5px 0; }
        /* æ„›å¿ƒæŒ‰éˆ•æ¨£å¼ */
        .fav-btn { cursor: pointer; color: #ccc; font-size: 1.2em; padding: 5px; transition: color 0.2s; }
        .fav-btn.active { color: #e74c3c; }
        .fav-badge { position: absolute; top: 10px; right: 10px; color: #e74c3c; display: none; }
        .card.is-fav { border: 2px solid #e74c3c; }
        .card.is-fav .fav-badge { display: block; }

        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: opacity 0.3s; pointer-events: none; opacity: 0; }
        #loading.show { opacity: 1; pointer-events: all; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #2c3e50; border-radius: 50%; width: 30px; height: 30px; animation: spin 0.8s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Popup å„ªåŒ– */
        .custom-popup .leaflet-popup-content-wrapper { padding: 0; overflow: hidden; border-radius: 12px; }
        .custom-popup .leaflet-popup-content { margin: 0; width: 300px !important; }
        .popup-header { padding: 12px 15px; color: white; text-align: center; font-weight: bold; font-size: 1.1em; display: flex; justify-content: space-between; align-items: center;}
        .popup-body { padding: 0 15px 10px 15px; text-align: center; }
        
        .info-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 10px 0; }
        .info-item { background: #f8f9fa; padding: 8px 4px; border-radius: 8px; font-size: 0.85em; display: flex; flex-direction: column; align-items: center; text-align: center; }
        .info-label { color: #888; font-size: 0.8em; margin-bottom: 2px; }
        .info-val { font-weight: bold; font-size: 1.1em; color: #333; }
        .wind-arrow { transform-origin: center; display: inline-block; transition: transform 0.5s ease-out; color: #2980b9;}

        .pollutant-row { display: flex; justify-content: space-around; color: #666; font-size: 0.9em; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 10px;}
        
        .chart-container { position: relative; height: 120px; width: 100%; margin-top: 5px; display: none; }
        .chart-loading { font-size: 0.8em; color: #999; margin-top: 10px; display: block;}

        /* åˆ†äº«æŒ‰éˆ•å€ */
        .action-row { display: flex; gap: 10px; margin-top: 10px; }
        .action-btn { flex: 1; padding: 8px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 0.9em; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-copy { background: #2ecc71; color: white; }
        .btn-fav { background: #ecf0f1; color: #555; }
        .btn-fav.active { background: #fadbd8; color: #c0392b; }
    </style>
</head>
<body>

    <header>
        <div class="title-group">
            <h1><i class="fa-solid fa-heart-circle-check"></i> å°ç£ç©ºæ°£ V14</h1>
            <div id="update-time" class="update-time">ç­‰å¾…æ›´æ–°...</div>
        </div>
        <div class="view-switch">
            <button id="btn-map" class="btn active" onclick="switchView('map')">åœ°åœ–</button>
            <button id="btn-list" class="btn" onclick="switchView('list')">åˆ—è¡¨</button>
        </div>
    </header>

    <div id="main-container">
        <div id="loading" class="show">
            <div class="spinner"></div>
            <div id="loading-text">è¼‰å…¥ä¸­...</div>
        </div>
        
        <div id="map-view" style="width: 100%; height: 100%;"></div>
        
        <button class="gps-btn" onclick="locateUser()" title="å®šä½æˆ‘çš„ä½ç½®">
            <i class="fa-solid fa-crosshairs"></i>
        </button>

        <div id="list-view">
            <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” æœå°‹ç¸£å¸‚æˆ–æ¸¬ç«™..." onkeyup="filterList()">
            <div id="dashboard" class="grid"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <script>
        const API_KEY = "d62dcdf1-adf6-49dd-9c9c-b65b1556323d"; 
        const API_FIELDS = "sitename,county,aqi,status,pm2.5,pm10,longitude,latitude,publishtime";
        const API_URL = `https://data.moenv.gov.tw/api/v2/aqx_p_432?language=zh&api_key=${API_KEY}&$select=${API_FIELDS}`;
        
        const CACHE_KEY = "AQI_DATA_CACHE_V14";
        const CACHE_TIME_KEY = "AQI_LAST_UPDATE_V14";
        const FAV_KEY = "AQI_FAVORITES";

        let map, markersLayer, userMarker;
        let allData = [];
        let favorites = []; // å„²å­˜æ”¶è—çš„æ¸¬ç«™åç¨±
        let currentChart = null;
        let isListRendered = false;

        window.onload = () => {
            loadFavorites(); // è¼‰å…¥æ”¶è—
            setTimeout(() => { document.getElementById('loading').classList.remove('show'); }, 4000);

            try {
                initMap();
                const cachedData = loadFromCache();
                if (cachedData) {
                    allData = cachedData;
                    renderMap(allData);
                    document.getElementById('loading').classList.remove('show');
                    const lastTime = localStorage.getItem(CACHE_TIME_KEY);
                    if(lastTime) document.getElementById('update-time').innerText = `${lastTime} (å¿«å–)`;
                }
                fetchData(cachedData ? false : true);
                setInterval(() => { fetchData(false); }, 600000); 
            } catch (e) { console.error("Init Error", e); }
        };

        function initMap() {
            const osmMap = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM', maxZoom: 19 });
            const satelliteMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '&copy; Esri' });

            map = L.map('map-view', { zoomControl: false, layers: [osmMap] }).setView([23.7, 121.0], 7);
            L.control.layers({ "ğŸ—ºï¸ åœ°åœ–": osmMap, "ğŸ›°ï¸ è¡›æ˜Ÿ": satelliteMap }).addTo(map);
            L.control.zoom({ position: 'bottomleft' }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);

            map.on('popupopen', function(e) {
                const marker = e.popup._source;
                if (marker.stationData) setTimeout(() => loadStationDetails(marker.stationData), 10);
            });
        }

        async function fetchData(showLoading) {
            const timeDisplay = document.getElementById('update-time');
            const loadingEl = document.getElementById('loading');
            if (showLoading) loadingEl.classList.add('show');
            if (!showLoading) timeDisplay.innerText = "æ›´æ–°ä¸­...";

            try {
                const controller = new AbortController();
                const id = setTimeout(() => controller.abort(), 10000);
                const res = await fetch(`${API_URL}&t=${new Date().getTime()}`, { signal: controller.signal });
                clearTimeout(id);
                if (!res.ok) throw new Error("API Error");
                const json = await res.json();
                
                if (json.records && json.records.length > 0) {
                    allData = json.records;
                    renderMap(allData);
                    if (document.getElementById('list-view').style.display === 'block') renderList(allData);
                    else isListRendered = false;
                    saveToCache(allData);
                    const now = new Date();
                    const timeString = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
                    timeDisplay.innerText = `${timeString} æ›´æ–°`;
                    localStorage.setItem(CACHE_TIME_KEY, timeString);
                }
            } catch (e) {
                console.error(e);
                timeDisplay.innerText = "æ›´æ–°å¤±æ•—";
            } finally {
                loadingEl.classList.remove('show');
            }
        }

        // --- äº’å‹•åŠŸèƒ½å€ ---
        function loadFavorites() {
            try { favorites = JSON.parse(localStorage.getItem(FAV_KEY)) || []; } catch(e) { favorites = []; }
        }
        
        function toggleFavorite(sitename) {
            if (favorites.includes(sitename)) {
                favorites = favorites.filter(n => n !== sitename);
            } else {
                favorites.push(sitename);
            }
            localStorage.setItem(FAV_KEY, JSON.stringify(favorites));
            
            // æ›´æ–° UI
            if (document.getElementById('list-view').style.display === 'block') renderList(allData); // é‡æ–°æ’åºåˆ—è¡¨
            // å¦‚æœ Popup æ‰“é–‹ä¸­ï¼Œæ›´æ–° Popup æŒ‰éˆ•ç‹€æ…‹
            const btn = document.getElementById(`fav-btn-${sitename}`);
            if(btn) updateFavBtnUI(btn, favorites.includes(sitename));
        }

        function updateFavBtnUI(btn, isFav) {
            if (isFav) {
                btn.classList.add('active');
                btn.innerHTML = '<i class="fa-solid fa-heart"></i> å·²æ”¶è—';
            } else {
                btn.classList.remove('active');
                btn.innerHTML = '<i class="fa-regular fa-heart"></i> æ”¶è—';
            }
        }

        function copyReport(site, w) {
            let weatherText = w ? `ğŸŒ¡ï¸ ${w.temperature_2m}Â°C ğŸ’§ ${w.relative_humidity_2m}%` : "";
            let text = `ã€ç©ºæ°£å¿«å ±ã€‘${site.sitename}\n----------\nğŸ­ AQI: ${site.aqi} (${site.status})\nğŸŒ¬ï¸ PM2.5: ${site["pm2.5"]}\n${weatherText}\n----------\næŸ¥è©¢æ™‚é–“: ${new Date().toLocaleTimeString()}\n(ä¾†è‡ª: å°ç£ç©ºæ°£APP)`;
            
            navigator.clipboard.writeText(text).then(() => {
                alert("âœ… å ±å‘Šå·²è¤‡è£½ï¼è«‹è²¼ä¸Š Line æˆ– è¨Šæ¯");
            }).catch(() => {
                alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•æˆªåœ–");
            });
        }

        // ------------------

        function saveToCache(data) { try { localStorage.setItem(CACHE_KEY, JSON.stringify(data)); } catch (e) {} }
        function loadFromCache() { try { return JSON.parse(localStorage.getItem(CACHE_KEY)); } catch (e) { return null; } }

        function getAQIInfo(aqi) {
            if (aqi <= 50) return { color: '#009866', text: 'è‰¯å¥½' };
            if (aqi <= 100) return { color: '#FFDE33', text: 'æ™®é€š' };
            if (aqi <= 150) return { color: '#FF9933', text: 'æ•æ„Ÿ' };
            if (aqi <= 200) return { color: '#CC0033', text: 'ä¸å¥åº·' };
            if (aqi <= 300) return { color: '#660099', text: 'æ¥µå·®' };
            return { color: '#7E0023', text: 'å±å®³' };
        }

        function renderMap(data) {
            if(!data || data.length === 0) return;
            markersLayer.clearLayers();
            data.forEach(site => {
                if (!site.latitude || !site.longitude) return;
                const aqi = parseInt(site.aqi);
                const info = getAQIInfo(aqi);
                
                // æ”¶è—çš„ç«™é»åŠ ç²—åœˆåœˆ
                const isFav = favorites.includes(site.sitename);
                const weight = isFav ? 4 : 1.5;
                const strokeColor = isFav ? '#e74c3c' : '#fff';

                const marker = L.circleMarker([site.latitude, site.longitude], {
                    radius: 7, fillColor: info.color, color: strokeColor, weight: weight, fillOpacity: 0.9
                });
                marker.stationData = site;
                marker.bindPopup(generatePopupContent(site, info, false), { className: 'custom-popup' });
                markersLayer.addLayer(marker);
            });
        }

        function generatePopupContent(site, info, isNearestLabel) {
            const labelHtml = isNearestLabel ? `<div style="background:#2c3e50;color:white;padding:2px 6px;border-radius:4px;font-size:0.8em;display:inline-block;margin-bottom:5px;">ğŸ“ é›¢æ‚¨æœ€è¿‘</div><br>` : '';
            const canvasId = `chart-${Math.random().toString(36).substr(2, 5)}`;
            const infoId = `info-${canvasId}`;
            const isFav = favorites.includes(site.sitename);

            return `
                <div class="popup-header" style="background:${info.color}; color:${parseInt(site.aqi)>50 && parseInt(site.aqi)<=100 ? '#333':'#fff'}">
                    <span>${site.sitename}</span> <span>AQI ${site.aqi}</span>
                </div>
                <div class="popup-body">
                    <div style="margin-top:10px;">${labelHtml}</div>
                    <div class="pollutant-row"><span>PM2.5: <b>${site["pm2.5"]}</b></span><span>PM10: <b>${site.pm10}</b></span></div>
                    
                    <div id="${infoId}" class="info-grid">
                        <div class="info-item"><i class="fa-solid fa-spinner fa-spin"></i></div>
                        <div class="info-item"><i class="fa-solid fa-spinner fa-spin"></i></div>
                        <div class="info-item"><i class="fa-solid fa-spinner fa-spin"></i></div>
                    </div>

                    <div class="action-row">
                        <button id="fav-btn-${site.sitename}" class="action-btn btn-fav ${isFav?'active':''}" onclick="toggleFavorite('${site.sitename}')">
                            <i class="${isFav ? 'fa-solid' : 'fa-regular'} fa-heart"></i> ${isFav ? 'å·²æ”¶è—' : 'æ”¶è—'}
                        </button>
                        <button class="action-btn btn-copy" onclick="window.copyCurrentReport()">
                            <i class="fa-regular fa-copy"></i> è¤‡è£½å ±å‘Š
                        </button>
                    </div>

                    <div style="margin-top:10px;">
                        <div style="font-size:0.8em; font-weight:bold; color:#ccc; text-align:left;">24h è¶¨å‹¢</div>
                        <div id="loading-${canvasId}" class="chart-loading">è¼‰å…¥ä¸­...</div>
                        <div class="chart-container" id="container-${canvasId}"><canvas id="${canvasId}"></canvas></div>
                    </div>
                </div>
            `;
        }

        async function loadStationDetails(site) {
            const canvas = document.querySelector('.custom-popup canvas');
            if (!canvas) return;
            const canvasId = canvas.id;
            const infoId = `info-${canvasId}`;
            const loadingDiv = document.getElementById(`loading-${canvasId}`);
            const containerDiv = document.getElementById(`container-${canvasId}`);
            const infoDiv = document.getElementById(infoId);

            // ç¶å®šå…¨åŸŸè¤‡è£½å‡½æ•¸ (å› ç‚º onclick æ˜¯åœ¨ HTML string ä¸­)
            window.copyCurrentReport = () => { }; // é è¨­ç©º

            try {
                const lat = site.latitude;
                const lon = site.longitude;
                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m,uv_index&timezone=auto`;
                const aqiUrl = `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5&timezone=auto&past_days=1&forecast_days=0`;
                
                const [resWeather, resAqi] = await Promise.all([fetch(weatherUrl), fetch(aqiUrl)]);
                const weatherJson = await resWeather.json();
                const aqiJson = await resAqi.json();
                const w = weatherJson.current;

                // æ›´æ–°å…¨åŸŸè¤‡è£½å‡½æ•¸ï¼Œå¸¶å…¥å¤©æ°£æ•¸æ“š
                window.copyCurrentReport = () => copyReport(site, w);

                let uvClass = "#27ae60";
                if(w.uv_index > 3) uvClass = "#f39c12";
                if(w.uv_index > 6) uvClass = "#e74c3c";
                if(w.uv_index > 8) uvClass = "#8e44ad";

                infoDiv.innerHTML = `
                    <div class="info-item"><div class="info-label">æ°£æº«/æ¿•åº¦</div><div class="info-val">${w.temperature_2m}Â° <span style="font-size:0.7em;">${w.relative_humidity_2m}%</span></div></div>
                    <div class="info-item"><div class="info-label">UVæŒ‡æ•¸</div><div class="info-val" style="color:${uvClass}">${w.uv_index}</div></div>
                    <div class="info-item"><div class="info-label">é¢¨å‘</div><div style="display:flex;align-items:center;gap:3px;"><i class="fa-solid fa-location-arrow wind-arrow" style="transform: rotate(${w.wind_direction_10m + 180}deg);"></i><span style="font-size:0.9em;">${w.wind_speed_10m}</span></div></div>
                `;

                // Chart
                const len = aqiJson.hourly.time.length;
                const labels = aqiJson.hourly.time.slice(len-24, len).map(t => t.slice(11, 16));
                const dataPoints = aqiJson.hourly.pm2_5.slice(len-24, len);
                loadingDiv.style.display = 'none';
                containerDiv.style.display = 'block';
                if (currentChart) currentChart.destroy();
                const ctx = canvas.getContext('2d');
                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: 'PM2.5', data: dataPoints, borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', borderWidth: 2, fill: true, tension: 0.4, pointRadius: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: true, ticks: { font: {size: 9} } } } }
                });

            } catch (e) { console.error(e); }
        }

        function renderList(data) {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';
            const fragment = document.createDocumentFragment();
            
            // æ’åºï¼šå…ˆæ’ "å·²æ”¶è—" çš„ï¼Œå†æ’ "AQI é«˜ (ç©ºæ°£å·®)" çš„
            const sortedData = [...data].sort((a, b) => {
                const aFav = favorites.includes(a.sitename);
                const bFav = favorites.includes(b.sitename);
                if (aFav && !bFav) return -1; // a åœ¨å‰
                if (!aFav && bFav) return 1;  // b åœ¨å‰
                // éƒ½æ”¶è—æˆ–éƒ½ä¸æ”¶è—ï¼Œå‰‡æ¯”è¼ƒ AQI
                return parseInt(b.aqi) - parseInt(a.aqi);
            });

            sortedData.forEach(site => {
                const aqi = parseInt(site.aqi);
                const info = getAQIInfo(aqi);
                const isFav = favorites.includes(site.sitename);

                const card = document.createElement('div');
                card.className = `card ${isFav ? 'is-fav' : ''}`;
                // é»æ“Šå¡ç‰‡åˆ‡æ›åœ°åœ–
                card.onclick = (e) => {
                    // å¦‚æœé»åˆ°æ„›å¿ƒï¼Œä¸è¦è§¸ç™¼åœ°åœ–è·³è½‰
                    if(e.target.closest('.fav-btn')) return;
                    switchView('map');
                    const m = findMarkerBySitename(site.sitename);
                    if(m) { map.setView(m.getLatLng(), 13); m.openPopup(); }
                };

                card.innerHTML = `
                    <div class="fav-badge"><i class="fa-solid fa-heart"></i></div>
                    <div class="card-header">
                        <div><strong>${site.sitename}</strong> <span style="font-size:0.8em; color:#888">${site.county}</span></div>
                        <div class="fav-btn ${isFav?'active':''}" onclick="toggleFavorite('${site.sitename}')">
                            <i class="${isFav ? 'fa-solid' : 'fa-regular'} fa-heart"></i>
                        </div>
                    </div>
                    <div class="card-aqi" style="color:${info.color === '#FFDE33' ? '#d4b106' : info.color}">${site.aqi}</div>
                    <div class="card-status" style="background:${info.color}; color:white; padding:2px 8px; border-radius:10px;">${info.text}</div>
                `;
                fragment.appendChild(card);
            });
            dashboard.appendChild(fragment);
            isListRendered = true;
        }

        function switchView(mode) {
            document.getElementById('map-view').style.display = mode === 'map' ? 'block' : 'none';
            document.getElementById('list-view').style.display = mode === 'list' ? 'block' : 'none';
            document.querySelector('.gps-btn').style.display = mode === 'map' ? 'flex' : 'none';
            document.getElementById('btn-map').className = mode === 'map' ? 'btn active' : 'btn';
            document.getElementById('btn-list').className = mode === 'list' ? 'btn active' : 'btn';
            if(mode === 'map') { map.invalidateSize(); } 
            else if (mode === 'list') { renderList(allData); }
        }

        function filterList() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(d => d.sitename.includes(term) || d.county.includes(term));
            renderList(filtered); // æœå°‹æ™‚ä¸ä¸€å®šé‡æ’æ”¶è—ï¼Œç›´æ¥é¡¯ç¤ºçµæœ
        }

        function findMarkerBySitename(name) {
            let found = null;
            markersLayer.eachLayer(layer => { if(layer.stationData.sitename === name) found = layer; });
            return found;
        }

        function findNearestStation(lat, lng) {
            let nearest = null; let minDistance = Infinity;
            allData.forEach(site => {
                if (site.latitude && site.longitude) {
                    const dist = map.distance([lat, lng], [site.latitude, site.longitude]);
                    if (dist < minDistance) { minDistance = dist; nearest = site; }
                }
            });
            return { station: nearest, distance: minDistance };
        }

        function locateUser() {
            if (!navigator.geolocation) { alert("ç€è¦½å™¨ä¸æ”¯æ´å®šä½"); return; }
            const gpsBtn = document.querySelector('.gps-btn');
            gpsBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            navigator.geolocation.getCurrentPosition((pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude;
                map.setView([lat, lng], 14);
                const result = findNearestStation(lat, lng);
                const nearestSite = result.station;
                if (nearestSite) {
                    if (userMarker) map.removeLayer(userMarker);
                    userMarker = L.marker([lat, lng], {
                        icon: L.divIcon({ className: 'user-loc', html: '<i class="fa-solid fa-street-view" style="color:#2980b9; font-size:36px; text-shadow: 2px 2px 2px white;"></i>', iconSize: [36, 36], iconAnchor: [18, 36], popupAnchor: [0, -35] })
                    }).addTo(map);
                    userMarker.stationData = nearestSite;
                    const info = getAQIInfo(parseInt(nearestSite.aqi));
                    userMarker.bindPopup(generatePopupContent(nearestSite, info, true), { className: 'custom-popup' });
                    userMarker.openPopup();
                }
                gpsBtn.innerHTML = '<i class="fa-solid fa-crosshairs"></i>';
            }, () => { alert("å®šä½å¤±æ•—"); gpsBtn.innerHTML = '<i class="fa-solid fa-crosshairs"></i>'; });
        }
    </script>
</body>
</html>
