<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°ç£ç©ºæ°£å“è³ªåœ°åœ– V3</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        
        header { background-color: #2c3e50; color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 1000;}
        h1 { margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 5px; }
        
        /* åˆ‡æ›æŒ‰éˆ• */
        .view-switch { display: flex; background: rgba(255,255,255,0.2); border-radius: 20px; padding: 2px; }
        .btn { padding: 6px 12px; border: none; border-radius: 18px; cursor: pointer; font-size: 0.9rem; transition: 0.2s; background: transparent; color: rgba(255,255,255,0.7); }
        .btn.active { background-color: white; color: #2c3e50; font-weight: bold; shadow: 0 2px 4px rgba(0,0,0,0.2); }

        #main-container { flex: 1; position: relative; overflow: hidden; }

        /* åœ°åœ– GPS æŒ‰éˆ• */
        .gps-btn {
            position: absolute; bottom: 20px; right: 20px; z-index: 999;
            background: white; border: none; width: 50px; height: 50px;
            border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            cursor: pointer; font-size: 1.5rem; color: #3498db;
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s;
        }
        .gps-btn:active { transform: scale(0.9); }

        /* åˆ—è¡¨æ¨¡å¼ */
        #list-view { padding: 15px; overflow-y: auto; height: 100%; box-sizing: border-box; display: none; background: #f0f2f5; }
        
        .search-box { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: center; position: relative; overflow: hidden; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .card-aqi { font-size: 2.2em; font-weight: 800; margin: 5px 0; }
        .card-status { font-size: 0.9em; padding: 3px 8px; border-radius: 10px; color: white; display: inline-block;}
        
        /* è¼‰å…¥é®ç½© */
        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 2000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* AQI Colors */
        .c-good { color: #009866; } .bg-good { background: #009866; }
        .c-mod { color: #d4b106; } .bg-mod { background: #FFDE33; color: #333 !important; }
        .c-sen { color: #FF9933; } .bg-sen { background: #FF9933; }
        .c-un { color: #CC0033; } .bg-un { background: #CC0033; }
        .c-very { color: #660099; } .bg-very { background: #660099; }
        .c-haz { color: #7E0023; } .bg-haz { background: #7E0023; }

        /* Popup å„ªåŒ– */
        .custom-popup .leaflet-popup-content-wrapper { padding: 0; overflow: hidden; border-radius: 8px; }
        .custom-popup .leaflet-popup-content { margin: 0; width: 200px !important; }
        .popup-header { padding: 10px; color: white; text-align: center; font-weight: bold; }
        .popup-body { padding: 15px; text-align: center; }
        .advice-text { font-size: 0.9em; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; color: #555; }
    </style>
</head>
<body>

    <header>
        <h1><i class="fa-solid fa-wind"></i> å°ç£ç©ºæ°£ V3</h1>
        <div class="view-switch">
            <button id="btn-map" class="btn active" onclick="switchView('map')">åœ°åœ–</button>
            <button id="btn-list" class="btn" onclick="switchView('list')">åˆ—è¡¨</button>
        </div>
    </header>

    <div id="main-container">
        <div id="loading">
            <div class="spinner"></div>
            <div>æ•¸æ“šæ›´æ–°ä¸­...</div>
        </div>
        
        <div id="map-view" style="width: 100%; height: 100%;"></div>
        <button class="gps-btn" onclick="locateUser()" title="å®šä½æˆ‘çš„ä½ç½®">
            <i class="fa-solid fa-crosshairs"></i>
        </button>

        <div id="list-view">
            <input type="text" id="searchInput" class="search-box" placeholder="ğŸ” æœå°‹åœ°å€ (ä¾‹å¦‚: æ¿æ©‹)..." onkeyup="filterList()">
            <div id="dashboard" class="grid"></div>
        </div>
    </div>

    <script>
        const API_KEY = "d62dcdf1-adf6-49dd-9c9c-b65b1556323d"; // æ‚¨çš„ API Key
        const API_URL = `https://data.moenv.gov.tw/api/v2/aqx_p_432?language=zh&api_key=${API_KEY}`;

        let map, markersLayer, userMarker;
        let allData = [];

        window.onload = () => {
            initMap();
            fetchData();
        };

        function initMap() {
            map = L.map('map-view', { zoomControl: false }).setView([23.7, 121.0], 7);
            L.control.zoom({ position: 'bottomleft' }).addTo(map);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            }).addTo(map);

            markersLayer = L.layerGroup().addTo(map);
        }

        async function fetchData() {
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                allData = json.records;
                
                renderMap(allData);
                renderList(allData);
                document.getElementById('loading').style.display = 'none';
            } catch (e) {
                alert("æ•¸æ“šè¼‰å…¥å¤±æ•—");
                console.error(e);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function getAQIInfo(aqi) {
            if (aqi <= 50) return { color: '#009866', class: 'bg-good', text: 'è‰¯å¥½', advice: 'ğŸ˜Š ç©ºæ°£å¾ˆå¥½ï¼Œç›¡æƒ…äº«å—æˆ¶å¤–æ´»å‹•å§ï¼' };
            if (aqi <= 100) return { color: '#FFDE33', class: 'bg-mod', text: 'æ™®é€š', advice: 'ğŸ˜ ç©ºæ°£æ™®é€šï¼Œæ•æ„Ÿæ—ç¾¤è«‹æ³¨æ„ã€‚' };
            if (aqi <= 150) return { color: '#FF9933', class: 'bg-sen', text: 'å°æ•æ„Ÿæ—ç¾¤ä¸å¥åº·', advice: 'ğŸ˜· æ•æ„Ÿæ—ç¾¤å»ºè­°æˆ´å£ç½©ï¼Œæ¸›å°‘æˆ¶å¤–åŠ‡çƒˆæ´»å‹•ã€‚' };
            if (aqi <= 200) return { color: '#CC0033', class: 'bg-un', text: 'ä¸å¥åº·', advice: 'ğŸš« æ‰€æœ‰äººéƒ½æ‡‰æ¸›å°‘æˆ¶å¤–æ´»å‹•ï¼Œå¤–å‡ºè«‹æˆ´å£ç½©ã€‚' };
            if (aqi <= 300) return { color: '#660099', class: 'bg-very', text: 'éå¸¸ä¸å¥åº·', advice: 'âš ï¸ åš´é‡æ±¡æŸ“ï¼è«‹é¿å…å‡ºé–€ã€‚' };
            return { color: '#7E0023', class: 'bg-haz', text: 'å±å®³', advice: 'â˜ ï¸ å¥åº·å¨è„…ç·Šæ€¥ï¼Œè«‹ç•™åœ¨å®¤å…§ï¼' };
        }

        function renderMap(data) {
            markersLayer.clearLayers();
            data.forEach(site => {
                if (!site.latitude || !site.longitude) return;
                
                const aqi = parseInt(site.aqi);
                const info = getAQIInfo(aqi);

                const marker = L.circleMarker([site.latitude, site.longitude], {
                    radius: 8, fillColor: info.color, color: '#fff', weight: 1, fillOpacity: 0.9
                });

                const popupHtml = `
                    <div class="popup-header" style="background:${info.color}; color:${aqi>50 && aqi<=100 ? '#333':'#fff'}">
                        ${site.sitename} <span style="font-size:0.8em">AQI ${site.aqi}</span>
                    </div>
                    <div class="popup-body">
                        <div style="font-weight:bold; margin-bottom:5px;">${info.text}</div>
                        <div style="font-size:0.85em; display:flex; justify-content:space-around;">
                            <span>PM2.5: <b>${site["pm2.5"]}</b></span>
                            <span>PM10: <b>${site.pm10}</b></span>
                        </div>
                        <div class="advice-text">${info.advice}</div>
                    </div>
                `;

                marker.bindPopup(popupHtml, { className: 'custom-popup' });
                markersLayer.addLayer(marker);
            });
        }

        function renderList(data) {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';
            
            // ä¾ç…§ AQI ç”±é«˜åˆ°ä½æ’åº (ç©ºæ°£å·®çš„åœ¨å‰é¢)
            const sortedData = [...data].sort((a, b) => parseInt(b.aqi) - parseInt(a.aqi));

            sortedData.forEach(site => {
                const aqi = parseInt(site.aqi);
                const info = getAQIInfo(aqi);

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-header">
                        <strong>${site.sitename}</strong>
                        <span style="font-size:0.8em; color:#888">${site.county}</span>
                    </div>
                    <div class="card-aqi" style="color:${info.color === '#FFDE33' ? '#d4b106' : info.color}">
                        ${site.aqi}
                    </div>
                    <div class="card-status ${info.class}">${info.text}</div>
                `;
                dashboard.appendChild(card);
            });
        }

        function switchView(mode) {
            const mapEl = document.getElementById('map-view');
            const listEl = document.getElementById('list-view');
            const btnMap = document.getElementById('btn-map');
            const btnList = document.getElementById('btn-list');
            const gpsBtn = document.querySelector('.gps-btn');

            if (mode === 'map') {
                mapEl.style.display = 'block';
                gpsBtn.style.display = 'flex';
                listEl.style.display = 'none';
                btnMap.classList.add('active');
                btnList.classList.remove('active');
                map.invalidateSize();
            } else {
                mapEl.style.display = 'none';
                gpsBtn.style.display = 'none';
                listEl.style.display = 'block';
                btnMap.classList.remove('active');
                btnList.classList.add('active');
            }
        }

        function filterList() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(d => 
                d.sitename.includes(term) || d.county.includes(term)
            );
            renderList(filtered);
        }

        // GPS å®šä½åŠŸèƒ½
        function locateUser() {
            if (!navigator.geolocation) {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
                return;
            }

            const gpsBtn = document.querySelector('.gps-btn');
            gpsBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>'; // è½‰åœˆåœˆå‹•ç•«

            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const lat = pos.coords.latitude;
                    const lng = pos.coords.longitude;

                    // ç¸®æ”¾åˆ°ä½¿ç”¨è€…ä½ç½®
                    map.setView([lat, lng], 13);

                    // ç§»é™¤èˆŠçš„å®šä½é»
                    if (userMarker) map.removeLayer(userMarker);

                    // æ–°å¢è—è‰²å®šä½é»
                    userMarker = L.marker([lat, lng], {
                        icon: L.divIcon({
                            className: 'user-loc',
                            html: '<i class="fa-solid fa-location-dot" style="color:#2980b9; font-size:30px; text-shadow: 0 2px 5px rgba(0,0,0,0.3);"></i>',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        })
                    }).addTo(map).bindPopup("æ‚¨åœ¨é€™è£¡").openPopup();

                    gpsBtn.innerHTML = '<i class="fa-solid fa-crosshairs"></i>';
                },
                (err) => {
                    alert("ç„¡æ³•å–å¾—å®šä½ï¼Œè«‹ç¢ºèªæ˜¯å¦å…è¨±å­˜å–ä½ç½®æ¬Šé™ã€‚");
                    gpsBtn.innerHTML = '<i class="fa-solid fa-crosshairs"></i>';
                }
            );
        }
    </script>
</body>
</html>
