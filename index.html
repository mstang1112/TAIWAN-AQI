<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°ç£ç©ºæ°£å“è³ªåœ°åœ– (AQI)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }
        
        /* é ‚éƒ¨å°èˆªåˆ— */
        header { background-color: #2c3e50; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        h1 { margin: 0; font-size: 1.2rem; }
        
        /* åˆ‡æ›æŒ‰éˆ• */
        .view-switch { display: flex; gap: 10px; }
        .btn { padding: 8px 15px; border: none; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-active { background-color: #3498db; color: white; }
        .btn-inactive { background-color: #ecf0f1; color: #2c3e50; }

        /* ä¸»å…§å®¹å€ */
        #main-container { flex: 1; position: relative; overflow: hidden; }

        /* åˆ—è¡¨æ¨¡å¼æ¨£å¼ */
        #list-view { padding: 20px; overflow-y: auto; height: 100%; box-sizing: border-box; display: none; } /* é è¨­éš±è— */
        .controls { margin-bottom: 20px; text-align: center; }
        select { padding: 8px; font-size: 16px; border-radius: 5px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .aqi-value { font-size: 2em; font-weight: bold; margin: 5px 0; }
        .status-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; color: white; font-size: 0.9em; }

        /* åœ°åœ–æ¨¡å¼æ¨£å¼ */
        #map-view { width: 100%; height: 100%; }

        /* è¼‰å…¥ä¸­é®ç½© */
        #loading { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 999; display: flex; justify-content: center; align-items: center; font-size: 1.5em; color: #2c3e50; }

        /* é¡è‰²å®šç¾© */
        .aqi-1 { background-color: #009866; } /* è‰¯å¥½ */
        .aqi-2 { background-color: #FFDE33; color: #333 !important; } /* æ™®é€š */
        .aqi-3 { background-color: #FF9933; } /* æ•æ„Ÿ */
        .aqi-4 { background-color: #CC0033; } /* ä¸å¥åº· */
        .aqi-5 { background-color: #660099; } /* éå¸¸ä¸å¥åº· */
        .aqi-6 { background-color: #7E0023; } /* å±å®³ */

        /* åœ°åœ– Popup æ¨£å¼å„ªåŒ– */
        .leaflet-popup-content-wrapper { border-radius: 10px; }
        .popup-aqi { font-size: 1.5em; font-weight: bold; text-align: center; margin: 5px 0; }
    </style>
</head>
<body>

    <header>
        <h1>ğŸ‡¹ğŸ‡¼ ç©ºæ°£å“è³ªåœ°åœ–</h1>
        <div class="view-switch">
            <button id="btn-map" class="btn btn-active" onclick="switchView('map')">åœ°åœ–æ¨¡å¼</button>
            <button id="btn-list" class="btn btn-inactive" onclick="switchView('list')">åˆ—è¡¨æ¨¡å¼</button>
        </div>
    </header>

    <div id="main-container">
        <div id="loading">è³‡æ–™è¼‰å…¥ä¸­...</div>
        
        <div id="map-view"></div>

        <div id="list-view">
            <div class="controls">
                <select id="countySelect" onchange="filterList()">
                    <option value="all">å…¨å°ç£</option>
                </select>
                <button class="btn btn-active" onclick="fetchData()" style="padding: 8px 12px; font-size: 14px;">é‡æ–°æ•´ç†</button>
            </div>
            <div id="dashboard" class="grid"></div>
        </div>
    </div>

    <script>
        // è¨­å®šæ‚¨çš„ API Key
        const API_KEY = "d62dcdf1-adf6-49dd-9c9c-b65b1556323d";
        const API_URL = `https://data.moenv.gov.tw/api/v2/aqx_p_432?language=zh&api_key=${API_KEY}`;

        let allData = [];
        let map;
        let markersLayer; // ç”¨ä¾†ç®¡ç†åœ°åœ–ä¸Šçš„æ¨™è¨˜ç¾¤çµ„

        // åˆå§‹åŒ–
        window.onload = () => {
            initMap();
            fetchData();
        };

        // 1. åˆå§‹åŒ–åœ°åœ–
        function initMap() {
            // è¨­å®šåœ°åœ–ä¸­å¿ƒé» (å°ç£ä¸­å¿ƒ) èˆ‡ç¸®æ”¾å±¤ç´š
            map = L.map('map-view').setView([23.6, 121.0], 8);

            // åŠ å…¥ OpenStreetMap åœ–è³‡ (å…è²»)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            markersLayer = L.layerGroup().addTo(map);
        }

        // 2. æŠ“å–è³‡æ–™
        async function fetchData() {
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';

            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error("API é€£ç·šå¤±æ•—");
                const json = await res.json();
                allData = json.records;

                updateMap(allData);
                populateCounties(); // åˆ—è¡¨æ¨¡å¼çš„ä¸‹æ‹‰é¸å–®
                renderList(allData); // åˆ—è¡¨æ¨¡å¼çš„å¡ç‰‡
                
                loading.style.display = 'none';
            } catch (error) {
                alert("è³‡æ–™è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚\n" + error.message);
                loading.style.display = 'none';
            }
        }

        // 3. æ›´æ–°åœ°åœ–ä¸Šçš„é»
        function updateMap(data) {
            markersLayer.clearLayers(); // æ¸…é™¤èˆŠçš„é»

            data.forEach(site => {
                // æª¢æŸ¥æ˜¯å¦æœ‰ç¶“ç·¯åº¦è³‡æ–™
                if (site.latitude && site.longitude) {
                    const lat = parseFloat(site.latitude);
                    const lon = parseFloat(site.longitude);
                    const aqi = parseInt(site.aqi);
                    const color = getAQIColor(aqi);

                    // å»ºç«‹åœ“å½¢æ¨™è¨˜
                    const marker = L.circleMarker([lat, lon], {
                        radius: 10,
                        fillColor: color,
                        color: "#fff",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.9
                    });

                    // ç¶å®šå½ˆå‡ºè¦–çª— (Popup)
                    const popupContent = `
                        <div style="text-align:center; min-width: 100px;">
                            <strong>${site.sitename}</strong> <span style="font-size:0.8em; color:#777">(${site.county})</span>
                            <div class="popup-aqi" style="color:${color === '#FFDE33' ? '#d4b106' : color}">${site.aqi}</div>
                            <div style="font-size:0.9em;">ç‹€æ…‹: ${site.status}</div>
                            <div style="font-size:0.8em; color:#666; margin-top:5px;">PM2.5: ${site['pm2.5']}</div>
                        </div>
                    `;
                    marker.bindPopup(popupContent);
                    markersLayer.addLayer(marker);
                }
            });
        }

        // 4. æ¸²æŸ“åˆ—è¡¨æ¨¡å¼
        function renderList(data) {
            const dashboard = document.getElementById('dashboard');
            dashboard.innerHTML = '';

            data.forEach(site => {
                const aqi = parseInt(site.aqi);
                const colorClass = getAQIClass(aqi);
                const colorHex = getAQIColor(aqi);

                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>${site.sitename}</h3>
                    <div class="aqi-value" style="color:${colorHex === '#FFDE33' ? '#d4b106' : colorHex}">${site.aqi}</div>
                    <div class="status-badge ${colorClass}">${site.status}</div>
                    <div style="font-size:0.8em; margin-top:10px; color:#777">${site.county}</div>
                `;
                dashboard.appendChild(card);
            });
        }

        // è¼”åŠ©åŠŸèƒ½ï¼šé¡è‰²ä»£ç¢¼
        function getAQIColor(aqi) {
            if (aqi <= 50) return '#009866';
            if (aqi <= 100) return '#FFDE33';
            if (aqi <= 150) return '#FF9933';
            if (aqi <= 200) return '#CC0033';
            if (aqi <= 300) return '#660099';
            return '#7E0023';
        }

        // è¼”åŠ©åŠŸèƒ½ï¼šCSS é¡åˆ¥
        function getAQIClass(aqi) {
            if (aqi <= 50) return 'aqi-1';
            if (aqi <= 100) return 'aqi-2';
            if (aqi <= 150) return 'aqi-3';
            if (aqi <= 200) return 'aqi-4';
            if (aqi <= 300) return 'aqi-5';
            return 'aqi-6';
        }

        // ä»‹é¢åˆ‡æ›é‚è¼¯
        function switchView(mode) {
            const mapView = document.getElementById('map-view');
            const listView = document.getElementById('list-view');
            const btnMap = document.getElementById('btn-map');
            const btnList = document.getElementById('btn-list');

            if (mode === 'map') {
                mapView.style.display = 'block';
                listView.style.display = 'none';
                btnMap.className = 'btn btn-active';
                btnList.className = 'btn btn-inactive';
                setTimeout(() => { map.invalidateSize(); }, 100); // ä¿®æ­£åœ°åœ–é¡¯ç¤ºå•é¡Œ
            } else {
                mapView.style.display = 'none';
                listView.style.display = 'block';
                btnMap.className = 'btn btn-inactive';
                btnList.className = 'btn btn-active';
            }
        }

        // åˆ—è¡¨ç¯©é¸é‚è¼¯
        function populateCounties() {
            const select = document.getElementById('countySelect');
            if (select.options.length > 1) return;
            const counties = [...new Set(allData.map(item => item.county))];
            counties.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.innerText = c;
                select.appendChild(opt);
            });
        }

        function filterList() {
            const val = document.getElementById('countySelect').value;
            if (val === 'all') renderList(allData);
            else renderList(allData.filter(d => d.county === val));
        }
    </script>
</body>
</html>
